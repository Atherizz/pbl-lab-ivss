# .github/workflows/main.yml
name: CI/CD Pipeline - Azure ACR & SSH Deploy

on:
  push:
    branches: [ "main" ] # Pipeline runs only on push to the 'main' branch

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_NAME }}.azurecr.io
  ACR_REPO_IMAGE: ivss/php-app # Defines the repository path within ACR (e.g., ivsslabcr.azurecr.io/ivss/php-app)
  IMAGE_TAG: prod          

jobs:
  
  # =======================================================
  # JOB 1: CI (Build, Push to ACR)
  # =======================================================
  build:
    name: Build & Push Image to ACR
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Azure Login (Mandatory for ACR)
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} # Requires Azure Service Principal Secret

      # 2. Docker Login to ACR 
      - name: Docker Login to ACR
        # Note: This uses separate AZURE_CLIENT_ID/SECRET for explicit Docker login, though Azure Login often helps
        run: docker login ${{ env.ACR_LOGIN_SERVER }} -u ${{ secrets.AZURE_CLIENT_ID }} -p ${{ secrets.AZURE_CLIENT_SECRET }} 

      # 3. Set up Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. Build and Push Image to ACR
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Construct the full image path: ACR_SERVER/REPO_IMAGE:TAG
          tags: ${{ env.ACR_LOGIN_SERVER }}/${{ env.ACR_REPO_IMAGE }}:${{ env.IMAGE_TAG }}
          
  # =======================================================
  # JOB 2: CD (Remote Deployment via SSH)
  # =======================================================
  deploy-to-server:
    name: Deploy & Restart PHP-App Service
    runs-on: ubuntu-latest
    needs: [build] # This job runs only if the 'build' job succeeds
    
    steps:
      - name: Deploy via SSH to Azure VM Server
        uses: appleboy/ssh-action@v1.0.1
        with:
          # SSH Secrets for the Virtual Machine (VM)
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # --- START: Deployment Commands on Target Server ---
            
            cd /home/azureuser/ivss-lab-app
            
            echo "Deployment started. Pulling latest image for php-app from ACR..."
            
            # 1. Pull the newest image for the 'php-app' service from ACR
            # (Note: The image name in docker-compose.yml MUST reference the ACR path)
            docker compose pull php-app
            
            # 2. Recreate and start the 'php-app' container with the new image
            docker compose up -d php-app
            
            echo "Deployment Complete. Service php-app successfully restarted."
            # --- END: Deployment Commands on Target Server ---
